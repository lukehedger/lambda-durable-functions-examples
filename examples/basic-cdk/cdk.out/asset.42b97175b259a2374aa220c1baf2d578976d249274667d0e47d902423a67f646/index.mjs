import{OperationStatus as b,OperationAction as R,OperationType as x,LambdaClient as je,GetDurableExecutionStateCommand as Be,CheckpointDurableExecutionCommand as Ge}from"@aws-sdk/client-lambda";import{EventEmitter as Le}from"events";import{AsyncLocalStorage as Ke}from"async_hooks";import{createHash as Je}from"crypto";import{Console as Xe}from"node:console";import Ne from"node:util";var I;(function(n){n.ExecutionMode="ExecutionMode",n.ReplayMode="ReplayMode",n.ReplaySucceededContext="ReplaySucceededContext"})(I||(I={}));var G;(function(n){n.SUCCEEDED="SUCCEEDED",n.FAILED="FAILED",n.PENDING="PENDING"})(G||(G={}));var k;(function(n){n.STEP="Step",n.WAIT="Wait",n.CALLBACK="Callback",n.RUN_IN_CHILD_CONTEXT="RunInChildContext",n.MAP="Map",n.MAP_ITERATION="MapIteration",n.PARALLEL="Parallel",n.PARALLEL_BRANCH="ParallelBranch",n.WAIT_FOR_CALLBACK="WaitForCallback",n.WAIT_FOR_CONDITION="WaitForCondition",n.CHAINED_INVOKE="ChainedInvoke"})(k||(k={}));var U;(function(n){n.INFO="INFO",n.WARN="WARN",n.ERROR="ERROR",n.DEBUG="DEBUG"})(U||(U={}));var Y;(function(n){n.AtMostOncePerRetry="AT_MOST_ONCE_PER_RETRY",n.AtLeastOncePerRetry="AT_LEAST_ONCE_PER_RETRY"})(Y||(Y={}));var j;(function(n){n.NONE="NONE",n.FULL="FULL",n.HALF="HALF"})(j||(j={}));var N;(function(n){n.SUCCEEDED="SUCCEEDED",n.FAILED="FAILED",n.STARTED="STARTED"})(N||(N={}));var A=class{_promise=null;_executor;_isExecuted=!1;constructor(e){this._executor=e}ensureExecution(){return this._promise||(this._isExecuted=!0,this._promise=this._executor()),this._promise}then(e,t){return this.ensureExecution().then(e,t)}catch(e){return this.ensureExecution().catch(e)}finally(e){return this.ensureExecution().finally(e)}get[Symbol.toStringTag](){return"DurablePromise"}get isExecuted(){return this._isExecuted}};function O(n){let e="days"in n?n.days??0:0,t="hours"in n?n.hours??0:0,r="minutes"in n?n.minutes??0:0,i="seconds"in n?n.seconds??0:0;return e*24*60*60+t*60*60+r*60+i}var Ye=n=>{try{let e=new WeakSet;return JSON.stringify(n,(t,r)=>{if(typeof r=="object"&&r!==null){if(e.has(r))return"[Circular]";if(e.add(r),r instanceof Error)return{...r,name:r.name,message:r.message,stack:r.stack}}return r},2)}catch{return"[Unable to stringify]"}},u=(n,e,t)=>{process.env.DURABLE_VERBOSE_MODE==="true"&&console.debug(`${n} ${e}`,t?Ye(t):"")},L;(function(n){n.OPERATION_TERMINATED="OPERATION_TERMINATED",n.RETRY_SCHEDULED="RETRY_SCHEDULED",n.RETRY_INTERRUPTED_STEP="RETRY_INTERRUPTED_STEP",n.WAIT_SCHEDULED="WAIT_SCHEDULED",n.CALLBACK_PENDING="CALLBACK_PENDING",n.CHECKPOINT_FAILED="CHECKPOINT_FAILED",n.SERDES_FAILED="SERDES_FAILED",n.CONTEXT_VALIDATION_ERROR="CONTEXT_VALIDATION_ERROR",n.CUSTOM="CUSTOM"})(L||(L={}));var Oe=new Ke,oe=()=>Oe.getStore(),te=(n,e,t,r,i)=>Oe.run({contextId:n,parentId:e,attempt:r,durableExecutionMode:i},t),F=(n,e,t)=>{let r=n||"root",i=oe();if(i&&i.contextId!==r){let o=`Context usage error in "${e}": You are using a parent or sibling context instead of the current child context. Expected context ID: "${i.contextId}", but got: "${n}". When inside runInChildContext(), you must use the child context parameter, not the parent context.`;t.terminate({reason:L.CONTEXT_VALIDATION_ERROR,message:o,error:new Error(o)})}},Qe=16,H=n=>Je("md5").update(n).digest("hex").substring(0,Qe),Ve=(n,e)=>{let t=H(e);return n[t]};function Ze(n,e){if(!e)return u("\u{1F50D}","hasFinishedAncestor: No parentId provided"),!1;if(et(n,e))return u("\u{1F50D}","hasFinishedAncestor: Found ancestor with pending completion!",{parentId:e}),!0;let t=H(e);for(u("\u{1F50D}","hasFinishedAncestor: Starting check",{parentId:e,initialHashedId:t});t;){let r=n._stepData[t];if(u("\u{1F50D}","hasFinishedAncestor: Checking operation",{hashedId:t,hasOperation:!!r,status:r?.Status,type:r?.Type}),r?.Status===b.SUCCEEDED||r?.Status===b.FAILED)return u("\u{1F50D}","hasFinishedAncestor: Found finished ancestor!",{hashedId:t,status:r.Status}),!0;t=r?.ParentId}return u("\u{1F50D}","hasFinishedAncestor: No finished ancestor found"),!1}function et(n,e){let t=H(e);for(;t;){if(n.pendingCompletions.has(t))return!0;t=n._stepData[t]?.ParentId}return!1}function J(n,e,t){let r=oe();if(r?.parentId)return new Promise(async(o,a)=>{await new Promise(d=>setImmediate(d)),u("\u{1F50D}","Terminate called - checking context:",{hasActiveContext:!!r,contextId:r?.contextId,parentId:r?.parentId,reason:e,message:t});let c=Ze(n,r.parentId);if(u("\u{1F50D}","Ancestor check result:",{parentId:r.parentId,ancestorFinished:c}),c){u("\u{1F6D1}","Skipping termination - ancestor already finished:",{contextId:r.contextId,parentId:r.parentId,reason:e,message:t});return}let s=n.activeOperationsTracker;if(s&&s.hasActive()){u("\u23F3","Deferring termination - active operations in progress:",{activeCount:s.getCount(),reason:e,message:t});let d=setInterval(()=>{s.hasActive()||(clearInterval(d),u("\u2705","Active operations completed, proceeding with termination:",{reason:e,message:t}),n.terminationManager.terminate({reason:e,message:t}))},10);return}n.terminationManager.terminate({reason:e,message:t})});let i=n.activeOperationsTracker;return i&&i.hasActive()?(u("\u23F3","Deferring termination - active operations in progress:",{activeCount:i.getCount(),reason:e,message:t}),new Promise((o,a)=>{let c=setInterval(()=>{i.hasActive()||(clearInterval(c),u("\u2705","Active operations completed, proceeding with termination:",{reason:e,message:t}),n.terminationManager.terminate({reason:e,message:t}))},10)})):(n.terminationManager.terminate({reason:e,message:t}),new Promise(()=>{}))}function ae(n,e,t){return J(n,e.terminationReason,`Unrecoverable error in step ${t}: ${e.message}`)}var tt={maxAttempts:3,initialDelay:{seconds:5},maxDelay:{minutes:5},backoffRate:2,jitter:j.FULL,retryableErrors:[/.*/],retryableErrorTypes:[]},nt=(n,e)=>{switch(e){case j.NONE:return n;case j.FULL:return Math.random()*n;case j.HALF:return n/2+Math.random()*(n/2);default:return n}},Pe=(n={})=>{let e=n.retryableErrors===void 0&&n.retryableErrorTypes===void 0,t={...tt,...n,retryableErrors:n.retryableErrors??(e?[/.*/]:[])};return(r,i)=>{if(i>=t.maxAttempts)return{shouldRetry:!1};let o=t.retryableErrors.some(E=>E instanceof RegExp?E.test(r.message):r.message.includes(E)),a=t.retryableErrorTypes.some(E=>r instanceof E);if(!o&&!a)return{shouldRetry:!1};let c=O(t.initialDelay),s=O(t.maxDelay),d=Math.min(c*Math.pow(t.backoffRate,i-1),s),f=nt(d,t.jitter);return{shouldRetry:!0,delay:{seconds:Math.max(1,Math.round(f))}}}},Fe={default:Pe({maxAttempts:6,initialDelay:{seconds:5},maxDelay:{seconds:60},backoffRate:2,jitter:j.FULL}),noRetry:Pe({maxAttempts:1})},fe=class extends Error{constructor(e,t){super("The step execution process was initiated but failed to reach completion due to an interruption."),this.name="StepInterruptedError"}},Ee="allOperationsComplete",P=class extends Error{cause;errorData;stackTrace;constructor(e,t,r){super(e),this.name=this.constructor.name,this.cause=t,this.errorData=r}static fromErrorObject(e){let t=new Error(e.ErrorMessage);switch(t.name=e.ErrorType||"Error",t.stack=e.StackTrace?.join(`
`),e.ErrorType){case"StepError":return new Q(e.ErrorMessage||"Step failed",t,e.ErrorData);case"CallbackError":return new M(e.ErrorMessage||"Callback failed",t,e.ErrorData);case"InvokeError":return new K(e.ErrorMessage||"Invoke failed",t,e.ErrorData);case"ChildContextError":return new v(e.ErrorMessage||"Child context failed",t,e.ErrorData);case"WaitForConditionError":return new se(e.ErrorMessage||"Wait for condition failed",t,e.ErrorData);default:return new Q(e.ErrorMessage||"Unknown error",t,e.ErrorData)}}toErrorObject(){return{ErrorType:this.errorType,ErrorMessage:this.message,ErrorData:this.errorData,StackTrace:void 0}}},Q=class extends P{errorType="StepError";constructor(e,t,r){super(e||"Step failed",t,r)}},M=class extends P{errorType="CallbackError";constructor(e,t,r){super(e||"Callback failed",t,r)}},K=class extends P{errorType="InvokeError";constructor(e,t,r){super(e||"Invoke failed",t,r)}},v=class extends P{errorType="ChildContextError";constructor(e,t,r){super(e||"Child context failed",t,r)}},se=class extends P{errorType="WaitForConditionError";constructor(e,t,r){super(e||"Wait for condition failed",t,r)}},q={serialize:async(n,e)=>n!==void 0?JSON.stringify(n):void 0,deserialize:async(n,e)=>n!==void 0?JSON.parse(n):void 0};var ce=class extends Error{originalError;isUnrecoverable=!0;constructor(e,t){super(e),this.originalError=t,this.name=this.constructor.name,t?.stack&&(this.stack=`${this.stack}
Caused by: ${t.stack}`)}},ue=class extends ce{isUnrecoverableExecution=!0;constructor(e,t){super(`[Unrecoverable Execution] ${e}`,t)}},le=class extends ce{isUnrecoverableInvocation=!0;constructor(e,t){super(`[Unrecoverable Invocation] ${e}`,t)}};function rt(n){return n instanceof Error&&"isUnrecoverable"in n&&n.isUnrecoverable===!0}function it(n){return n instanceof Error&&"isUnrecoverableInvocation"in n&&n.isUnrecoverableInvocation===!0}var me=class extends le{terminationReason=L.SERDES_FAILED;constructor(e,t){super(e||"Serdes operation failed",t)}};async function he(n,e,t,r,i,o){try{let a={entityId:t,durableExecutionArn:o};return await n.serialize(e,a)}catch(a){let c=`Serialization failed for step ${r?`"${r}" `:""}(${t}): ${a instanceof Error?a.message:"Unknown serialization error"}`;return u("\u{1F4A5}","Serialization failed - terminating execution:",{stepId:t,stepName:r,error:a instanceof Error?a.message:String(a)}),i.terminate({reason:L.SERDES_FAILED,message:c}),new Promise(()=>{})}}async function W(n,e,t,r,i,o){try{let a={entityId:t,durableExecutionArn:o};return await n.deserialize(e,a)}catch(a){let c=`Deserialization failed for step ${r?`"${r}" `:""}(${t}): ${a instanceof Error?a.message:"Unknown deserialization error"}`;return u("\u{1F4A5}","Deserialization failed - terminating execution:",{stepId:t,stepName:r,error:a instanceof Error?a.message:String(a)}),i.terminate({reason:L.SERDES_FAILED,message:c}),new Promise(()=>{})}}function at(n){return n instanceof Error||n!=null&&typeof n=="object"&&"message"in n&&"name"in n}function _(n,e){return n instanceof P?n.toErrorObject():at(n)?{ErrorData:e,ErrorMessage:n.message,ErrorType:n.name,StackTrace:void 0}:{ErrorData:e,ErrorMessage:"Unknown error"}}var de=class extends le{terminationReason=L.CHECKPOINT_FAILED;constructor(e,t){super(e||"Checkpoint operation failed",t)}},ge=class extends ue{terminationReason=L.CHECKPOINT_FAILED;constructor(e,t){super(e||"Checkpoint operation failed",t)}},Ce="stepDataUpdated",ye=class n{durableExecutionArn;stepData;storage;terminationManager;activeOperationsTracker;stepDataEmitter;logger;pendingCompletions;queue=[];isProcessing=!1;currentTaskToken;forceCheckpointPromises=[];queueCompletionResolver=null;queueCompletionTimeout=null;MAX_PAYLOAD_SIZE=750*1024;isTerminating=!1;static textEncoder=new TextEncoder;constructor(e,t,r,i,o,a,c,s,d){this.durableExecutionArn=e,this.stepData=t,this.storage=r,this.terminationManager=i,this.activeOperationsTracker=o,this.stepDataEmitter=c,this.logger=s,this.pendingCompletions=d,this.currentTaskToken=a}setTerminating(){this.isTerminating=!0,u("\u{1F6D1}","Checkpoint manager marked as terminating")}hasPendingAncestorCompletion(e){let t=H(e);for(;t;){if(this.pendingCompletions.has(t))return!0;t=this.stepData[t]?.ParentId}return!1}async forceCheckpoint(){return this.isTerminating?(u("\u26A0\uFE0F","Force checkpoint skipped - termination in progress"),new Promise(()=>{})):new Promise((e,t)=>{this.forceCheckpointPromises.push({resolve:e,reject:t}),this.isProcessing||setImmediate(()=>{this.processQueue()})})}async waitForQueueCompletion(){if(!(this.queue.length===0&&!this.isProcessing))return new Promise((e,t)=>{this.queueCompletionResolver=e,this.queueCompletionTimeout=setTimeout(()=>{this.queueCompletionResolver=null,this.queueCompletionTimeout=null,this.clearQueue(),t(new Error("Timeout waiting for checkpoint queue completion"))},3e3)})}clearQueue(){this.queue=[],this.forceCheckpointPromises=[],this.notifyQueueCompletion()}async force(){return this.forceCheckpoint()}async checkpoint(e,t){return this.isTerminating?(u("\u26A0\uFE0F","Checkpoint skipped - termination in progress:",{stepId:e}),new Promise(()=>{})):(this.activeOperationsTracker&&this.activeOperationsTracker.increment(),new Promise((r,i)=>{(t.Action===R.SUCCEED||t.Action===R.FAIL)&&this.pendingCompletions.add(e);let o={stepId:e,data:t,resolve:()=>{this.activeOperationsTracker&&this.activeOperationsTracker.decrement(),r()},reject:a=>{this.activeOperationsTracker&&this.activeOperationsTracker.decrement(),i(a)}};this.queue.push(o),u("\u{1F4E5}","Checkpoint queued:",{stepId:e,queueLength:this.queue.length,isProcessing:this.isProcessing}),this.isProcessing||setImmediate(()=>{this.processQueue()})}))}hasFinishedAncestor(e){if(!e)return!1;let t=H(e);for(;t;){let r=this.stepData[t];if(r?.Status===b.SUCCEEDED||r?.Status===b.FAILED)return!0;t=r?.ParentId}return!1}classifyCheckpointError(e){let t=e instanceof Error?e:new Error(String(e)),r=e,i=r.$metadata?.httpStatusCode,o=r.name,a=r.message||t.message;return u("\u{1F50D}","Classifying checkpoint error:",{statusCode:i,errorName:o,errorMessage:a}),i&&i>=400&&i<500&&o==="InvalidParameterValueException"&&a.startsWith("Invalid Checkpoint Token")?new de(`Checkpoint failed: ${a}`,t):i&&i>=400&&i<500&&i!==429?new ge(`Checkpoint failed: ${a}`,t):new de(`Checkpoint failed: ${a}`,t)}async processQueue(){if(this.isProcessing)return;let e=this.queue.length>0,t=this.forceCheckpointPromises.length>0;if(!e&&!t)return;this.isProcessing=!0;let r=[],i=0,a=this.currentTaskToken.length+100;for(;this.queue.length>0;){let c=this.queue[0],s=n.textEncoder.encode(JSON.stringify(c)).length;if(a+s>this.MAX_PAYLOAD_SIZE&&r.length>0)break;if(this.queue.shift(),this.hasFinishedAncestor(c.data.ParentId)){u("\u26A0\uFE0F","Checkpoint skipped - ancestor finished:",{stepId:c.stepId,parentId:c.data.ParentId}),i++;continue}r.push(c),a+=s}u("\u{1F504}","Processing checkpoint batch:",{batchSize:r.length,remainingInQueue:this.queue.length,estimatedSize:a,maxSize:this.MAX_PAYLOAD_SIZE});try{(r.length>0||this.forceCheckpointPromises.length>0)&&await this.processBatch(r),r.forEach(s=>{(s.data.Action===R.SUCCEED||s.data.Action===R.FAIL)&&this.pendingCompletions.delete(s.stepId),s.resolve()});let c=this.forceCheckpointPromises.splice(0);c.forEach(s=>{s.resolve()}),u("\u2705","Checkpoint batch processed successfully:",{batchSize:r.length,skippedCount:i,forceRequests:c.length,newTaskToken:this.currentTaskToken})}catch(c){u("\u274C","Checkpoint batch failed:",{batchSize:r.length,error:c});let s=this.classifyCheckpointError(c);this.clearQueue(),this.terminationManager.terminate({reason:L.CHECKPOINT_FAILED,message:s.message,error:s})}finally{this.isProcessing=!1,this.queue.length>0?setImmediate(()=>{this.processQueue()}):this.notifyQueueCompletion()}}notifyQueueCompletion(){this.queueCompletionResolver&&(this.queueCompletionTimeout&&(clearTimeout(this.queueCompletionTimeout),this.queueCompletionTimeout=null),this.queueCompletionResolver(),this.queueCompletionResolver=null)}async processBatch(e){let t=e.map(o=>{let a=H(o.stepId);return{Type:o.data.Type||"STEP",Action:o.data.Action||"START",...o.data,Id:a,...o.data.ParentId&&{ParentId:H(o.data.ParentId)}}}),r={DurableExecutionArn:this.durableExecutionArn,CheckpointToken:this.currentTaskToken,Updates:t};u("\u23FA\uFE0F","Creating checkpoint batch:",{batchSize:t.length,checkpointToken:this.currentTaskToken,updates:t.map(o=>({Id:o.Id,Action:o.Action,Type:o.Type}))});let i=await this.storage.checkpoint(r,this.logger);i.CheckpointToken&&(this.currentTaskToken=i.CheckpointToken),i.NewExecutionState?.Operations&&this.updateStepDataFromCheckpointResponse(i.NewExecutionState.Operations)}updateStepDataFromCheckpointResponse(e){u("\u{1F504}","Updating stepData from checkpoint response:",{operationCount:e.length,operationIds:e.map(t=>t.Id).filter(Boolean)}),e.forEach(t=>{t.Id&&(this.stepData[t.Id]=t,u("\u{1F4DD}","Updated stepData entry:",t),this.stepDataEmitter.emit(Ce,t.Id))}),u("\u2705","StepData update completed:",{totalStepDataEntries:Object.keys(this.stepData).length})}getQueueStatus(){return{queueLength:this.queue.length,isProcessing:this.isProcessing}}};async function V(n){let{checkHasRunningOperations:e,checkStepStatus:t,checkTimer:r,scheduledEndTimestamp:i,stepId:o,context:a,hasRunningOperations:c,operationsEmitter:s,checkpoint:d,onAwaitedChange:f}=n,l=[],E=[],h=[],g=()=>{E.forEach(p=>clearTimeout(p)),h.forEach(p=>p())};if(r&&i){let p=new Promise(S=>{let D=Number(i)-Date.now();if(D>0){let y=setTimeout(()=>S({reason:"timer",timerExpired:!0}),D);E.push(y)}else S({reason:"timer",timerExpired:!0})});l.push(p)}if(e){let p=new Promise(S=>{if(!c())S({reason:"operations"});else{let D=()=>{S({reason:"operations"})};s.once(Ee,D),h.push(()=>s.off(Ee,D))}});l.push(p)}if(t){let p=a.getStepData(o)?.Status,S=H(o),D=new Promise(y=>{let w=a.getStepData(o)?.Status;if(p!==w)y({reason:"status"});else{let m=T=>{if(T===S){let z=a.getStepData(o)?.Status;p!==z&&y({reason:"status"})}};s.on(Ce,m),h.push(()=>s.off(Ce,m))}});l.push(D)}if(f){let p=new Promise(S=>{f(()=>{S({reason:"status"})})});l.push(p)}if(l.length===0)return{reason:"timeout"};let C=await Promise.race(l);return g(),C.reason==="timer"&&C.timerExpired&&d&&(d.force?await d.force():d.forceCheckpoint&&await d.forceCheckpoint()),C}var ee=class extends ue{terminationReason=L.CUSTOM;constructor(e){super(e),this.name="NonDeterministicExecutionError"}},ne=(n,e,t,r)=>{if(!(!t||!t.Type)){if(t.Type!==e.type){let i=new ee(`Non-deterministic execution detected: Operation type mismatch for step "${n}". Expected type "${t.Type}", but got "${e.type}". This indicates non-deterministic control flow in your workflow code.`);ae(r,i,n)}if(t.Name!==e.name){let i=new ee(`Non-deterministic execution detected: Operation name mismatch for step "${n}". Expected name "${t.Name??"undefined"}", but got "${e.name??"undefined"}". This indicates non-deterministic control flow in your workflow code.`);ae(r,i,n)}if(t.SubType!==e.subType){let i=new ee(`Non-deterministic execution detected: Operation subtype mismatch for step "${n}". Expected subtype "${t.SubType}", but got "${e.subType}". This indicates non-deterministic control flow in your workflow code.`);ae(r,i,n)}}},Ue=Symbol("CONTINUE_MAIN_LOOP"),Se=async(n,e,t,r,i,o,a)=>{let c=n.getStepData(e);if(!r())return J(n,L.RETRY_SCHEDULED,`Retry scheduled for ${t||e}`);await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!0,scheduledEndTimestamp:c?.StepDetails?.NextAttemptTimestamp,stepId:e,context:n,hasRunningOperations:r,operationsEmitter:i(),checkpoint:o,onAwaitedChange:a})},ot=(n,e,t,r,i,o,a,c,s,d)=>(f,l,E)=>{let h,g,C;typeof f=="string"||f===void 0?(h=f,g=l,C=E):(g=f,C=l);let p=r();u("\u25B6\uFE0F","Running step:",{stepId:p,name:h,options:C});let S=!1,D,y=m=>{D=m},w=(async()=>{for(;;)try{let m=n.getStepData(p);if(ne(p,{type:x.STEP,name:h,subType:k.STEP},m,n),m?.Status===b.SUCCEEDED)return await st(n,p,h,C?.serdes);if(m?.Status===b.FAILED)return(async()=>{if(m.StepDetails?.Error)throw P.fromErrorObject(m.StepDetails.Error);{let z=m?.StepDetails?.Result;throw new Q(z||"Unknown error")}})();if(m?.Status===b.PENDING){await Se(n,p,h,c,s,e,S?void 0:y);continue}if(m?.Status===b.STARTED&&(C?.semantics||Y.AtLeastOncePerRetry)===Y.AtMostOncePerRetry){u("\u26A0\uFE0F","Step was interrupted during execution:",{stepId:p,name:h});let X=new fe(p,h),B=(m?.StepDetails?.Attempt||0)+1,$;if(C?.retryStrategy!==void 0?$=C.retryStrategy(X,B):$=Fe.default(X,B),u("\u26A0\uFE0F","Should Retry Interrupted Step:",{stepId:p,name:h,currentAttempt:B,shouldRetry:$.shouldRetry,delayInSeconds:$.shouldRetry&&$.delay?O($.delay):void 0}),$.shouldRetry){await e.checkpoint(p,{Id:p,ParentId:d,Action:R.RETRY,SubType:k.STEP,Type:x.STEP,Error:_(X),Name:h,StepOptions:{NextAttemptDelaySeconds:$.delay?O($.delay):1}}),await Se(n,p,h,c,s,e,S?void 0:y);continue}else{await e.checkpoint(p,{Id:p,ParentId:d,Action:R.FAIL,SubType:k.STEP,Type:x.STEP,Error:_(X),Name:h});let ze=_(X);throw P.fromErrorObject(ze)}}let T=await ct(n,e,p,h,g,i,o,a,c,s,d,C,S?void 0:y);if(T===Ue)continue;return T}catch(m){throw m instanceof P?m:new Q(m instanceof Error?m.message:"Step failed",m instanceof Error?m:void 0)}})();return w.catch(()=>{}),new A(async()=>(S=!0,D&&D(),await w))},st=async(n,e,t,r=q)=>{u("\u23ED\uFE0F","Step already finished, returning cached result:",{stepId:e});let o=n.getStepData(e)?.StepDetails?.Result;return await W(r,o,e,t,n.terminationManager,n.durableExecutionArn)},ct=async(n,e,t,r,i,o,a,c,s,d,f,l,E)=>{let h=l?.semantics||Y.AtLeastOncePerRetry,g=l?.serdes||q;n.getStepData(t)?.Status!==b.STARTED&&(h===Y.AtMostOncePerRetry?await e.checkpoint(t,{Id:t,ParentId:f,Action:R.START,SubType:k.STEP,Type:x.STEP,Name:r}):e.checkpoint(t,{Id:t,ParentId:f,Action:R.START,SubType:k.STEP,Type:x.STEP,Name:r}));try{let S=n.getStepData(t)?.StepDetails?.Attempt||0,D={logger:o};a(t);let y;try{y=await te(t,f,()=>i(D),S+1,I.ExecutionMode)}finally{c(t)}let w=await he(g,y,t,r,n.terminationManager,n.durableExecutionArn);return await e.checkpoint(t,{Id:t,ParentId:f,Action:R.SUCCEED,SubType:k.STEP,Type:x.STEP,Payload:w,Name:r}),u("\u2705","Step completed successfully:",{stepId:t,name:r,result:y,semantics:h}),await W(g,w,t,r,n.terminationManager,n.durableExecutionArn)}catch(p){if(u("\u274C","Step failed:",{stepId:t,name:r,error:p,semantics:h}),rt(p))return u("\u{1F4A5}","Unrecoverable error detected:",{stepId:t,name:r,error:p.message}),ae(n,p,r||t);let D=(n.getStepData(t)?.StepDetails?.Attempt||0)+1,y;if(l?.retryStrategy!==void 0?y=l.retryStrategy(p instanceof Error?p:new Error("Unknown Error"),D):y=Fe.default(p instanceof Error?p:new Error("Unknown Error"),D),u("\u26A0\uFE0F","Should Retry:",{stepId:t,name:r,currentAttempt:D,shouldRetry:y.shouldRetry,delayInSeconds:y.shouldRetry&&y.delay?O(y.delay):void 0,semantics:h}),y.shouldRetry)return await e.checkpoint(t,{Id:t,ParentId:f,Action:R.RETRY,SubType:k.STEP,Type:x.STEP,Error:_(p),Name:r,StepOptions:{NextAttemptDelaySeconds:y.delay?O(y.delay):1}}),await Se(n,t,r,s,d,e,E),Ue;{await e.checkpoint(t,{Id:t,ParentId:f,Action:R.FAIL,SubType:k.STEP,Type:x.STEP,Error:_(p),Name:r});let w=_(p);throw P.fromErrorObject(w)}}},ut=(n,e,t,r,i,o,a)=>{function c(s,d,f,l){let E=typeof d=="string",h=E?s:void 0,g=E?d:s,C=E?f:d,p=E?l:f,S=t(),D=async()=>{u("\u{1F517}",`Invoke ${h||g} (${S}) - phase 1`);let m=n.getStepData(S);if(ne(S,{type:x.CHAINED_INVOKE,name:h,subType:k.CHAINED_INVOKE},m,n),m){u("\u23F8\uFE0F",`Invoke ${h||g} already exists (phase 1)`);return}let T=await he(p?.payloadSerdes||q,C,S,h,n.terminationManager,n.durableExecutionArn);await e.checkpoint(S,{Id:S,ParentId:o,Action:R.START,SubType:k.CHAINED_INVOKE,Type:x.CHAINED_INVOKE,Name:h,Payload:T,ChainedInvokeOptions:{FunctionName:g}}),u("\u{1F680}",`Invoke ${h||g} started (phase 1)`)},y=async()=>{for(u("\u{1F517}",`Invoke ${h||g} (${S}) - phase 2`);;){let m=n.getStepData(S);if(m?.Status===b.SUCCEEDED){let T=m.ChainedInvokeDetails;return a?.(),await W(p?.resultSerdes||q,T?.Result,S,h,n.terminationManager,n.durableExecutionArn)}if(m?.Status===b.FAILED||m?.Status===b.TIMED_OUT||m?.Status===b.STOPPED){let T=m.ChainedInvokeDetails;return(async()=>{throw T?.Error?new K(T.Error.ErrorMessage||"Invoke failed",T.Error.ErrorMessage?new Error(T.Error.ErrorMessage):void 0,T.Error.ErrorData):new K("Invoke failed")})()}if(m?.Status===b.STARTED){if(r()){u("\u23F3",`Invoke ${h||g} still in progress, waiting for other operations`),await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!1,stepId:S,context:n,hasRunningOperations:r,operationsEmitter:i()});continue}return u("\u23F3",`Invoke ${h||g} still in progress, terminating`),J(n,L.OPERATION_TERMINATED,S)}throw m&&m.Status!==void 0?new K(`Unexpected operation status: ${m.Status}`):new K("No step data found in phase 2 - this should not happen")}},w=D().then(()=>{u("\u2705","Invoke phase 1 complete:",{stepId:S,name:h||g})}).catch(m=>{throw u("\u274C","Invoke phase 1 error:",{stepId:S,error:m.message}),m});return w.catch(()=>{}),new A(async()=>(await w,await y()))}return c},Me=256*1024,lt=(n,e)=>{let t=n.getStepData(e);return t?t.Status===b.SUCCEEDED&&t.ContextDetails?.ReplayChildren?I.ReplaySucceededContext:t.Status===b.SUCCEEDED||t.Status===b.FAILED?I.ReplayMode:I.ExecutionMode:I.ExecutionMode},dt=(n,e,t,r,i,o,a)=>(c,s,d)=>{let f,l,E;typeof c=="string"||c===void 0?(f=c,l=s,E=d):(l=c,E=s);let h=r();u("\u{1F504}","Running child context:",{entityId:h,name:f});let g=n.getStepData(h);ne(h,{type:x.CONTEXT,name:f,subType:E?.subType||k.RUN_IN_CHILD_CONTEXT},g,n);let C,p,S=(async()=>{let D=n.getStepData(h);return D?.Status===b.SUCCEEDED||D?.Status===b.FAILED?ht(n,t,h,f,l,E,i,o):pt(n,e,t,h,f,l,E,i,o,a)})().then(D=>{C=D}).catch(D=>{p=D});return new A(async()=>{if(await S,p!==void 0)throw p;return C})},ht=async(n,e,t,r,i,o,a,c)=>{let s=o?.serdes||q,d=n.getStepData(t),f=d?.ContextDetails?.Result;if(d?.Status===b.FAILED)if(d.ContextDetails?.Error){let l=P.fromErrorObject(d.ContextDetails.Error);throw new v(l.message,l)}else throw new v("Child context failed");if(d?.ContextDetails?.ReplayChildren){u("\u{1F504}","ReplayChildren mode: Re-executing child context due to large payload:",{entityId:t,stepName:r});let l=c(n,e,I.ReplaySucceededContext,a(),t,void 0,t);return await te(t,t,()=>i(l))}return u("\u23ED\uFE0F","Child context already finished, returning cached result:",{entityId:t}),await W(s,f,t,r,n.terminationManager,n.durableExecutionArn)},pt=async(n,e,t,r,i,o,a,c,s,d)=>{let f=a?.serdes||q;if(n.getStepData(r)===void 0){let h=a?.subType||k.RUN_IN_CHILD_CONTEXT;e.checkpoint(r,{Id:r,ParentId:d,Action:R.START,SubType:h,Type:x.CONTEXT,Name:i})}let l=lt(n,r),E=s(n,t,l,c(),r,void 0,r);try{let h=await te(r,d,()=>o(E),void 0,l),g=await he(f,h,r,i,n.terminationManager,n.durableExecutionArn),C=g,p=!1;g&&Buffer.byteLength(g,"utf8")>Me&&(p=!0,a?.summaryGenerator?C=a.summaryGenerator(h):C="",u("\u{1F4E6}","Large payload detected, using ReplayChildren mode:",{entityId:r,name:i,payloadSize:Buffer.byteLength(g,"utf8"),limit:Me}));let S=a?.subType||k.RUN_IN_CHILD_CONTEXT;return await e.checkpoint(r,{Id:r,ParentId:d,Action:R.SUCCEED,SubType:S,Type:x.CONTEXT,Payload:C,ContextOptions:p?{ReplayChildren:!0}:void 0,Name:i}),u("\u2705","Child context completed successfully:",{entityId:r,name:i}),h}catch(h){u("\u274C","Child context failed:",{entityId:r,name:i,error:h});let g=a?.subType||k.RUN_IN_CHILD_CONTEXT;await e.checkpoint(r,{Id:r,ParentId:d,Action:R.FAIL,SubType:g,Type:x.CONTEXT,Error:_(h),Name:i});let C=_(h),p=P.fromErrorObject(C);throw new v(p.message,p)}},ft=(n,e,t,r,i,o,a)=>{function c(s,d){let f=typeof s=="string",l=f?s:void 0,E=f?d:s,h=O(E),g=t(),C=async S=>{u("\u23F2\uFE0F",`Wait executing (${S?"phase 2":"phase 1"}):`,{stepId:g,name:l,duration:E,seconds:h});let D=n.getStepData(g);for(ne(g,{type:x.WAIT,name:l,subType:k.WAIT},D,n);;){if(D=n.getStepData(g),D?.Status===b.SUCCEEDED){u("\u23ED\uFE0F","Wait already completed:",{stepId:g}),a?.();return}if(D||await e.checkpoint(g,{Id:g,ParentId:o,Action:R.START,SubType:k.WAIT,Type:x.WAIT,Name:l,WaitOptions:{WaitSeconds:h}}),D=n.getStepData(g),!r()){if(S)return J(n,L.WAIT_SCHEDULED,`Operation ${l||g} scheduled to wait`);u("\u23F8\uFE0F","Wait ready but not terminating (phase 1):",{stepId:g});return}await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!0,scheduledEndTimestamp:D?.WaitDetails?.ScheduledEndTimestamp,stepId:g,context:n,hasRunningOperations:r,operationsEmitter:i(),checkpoint:e})}},p=C(!1).then(()=>{u("\u2705","Wait phase 1 complete:",{stepId:g,name:l})});return p.catch(()=>{}),new A(async()=>{await p,await C(!0)})}return c},ve=Symbol("CONTINUE_MAIN_LOOP"),$e=async(n,e,t,r,i,o,a)=>{let c=n.getStepData(e);if(!r())return J(n,L.RETRY_SCHEDULED,`Retry scheduled for ${t||e}`);await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!0,scheduledEndTimestamp:c?.StepDetails?.NextAttemptTimestamp,stepId:e,context:n,hasRunningOperations:r,operationsEmitter:o,checkpoint:i,onAwaitedChange:a})},Et=(n,e,t,r,i,o,a,c,s)=>(d,f,l)=>{let E=!1,h,g=p=>{h=p},C=(async()=>{let p,S,D;if(typeof d=="string"||d===void 0?(p=d,S=f,D=l):(S=d,D=f),!D||!D.waitStrategy||D.initialState===void 0)throw new Error("waitForCondition requires config with waitStrategy and initialState");let y=t();for(u("\u{1F504}","Running waitForCondition:",{stepId:y,name:p,config:D});;)try{let w=n.getStepData(y);if(w?.Status===b.SUCCEEDED)return await mt(n,y,p,D.serdes);if(w?.Status===b.FAILED)return(async()=>{if(w.StepDetails?.Error)throw P.fromErrorObject(w.StepDetails.Error);{let T=w?.StepDetails?.Result;throw new se(T||"waitForCondition failed")}})();if(w?.Status===b.PENDING){await $e(n,y,p,a,e,c(),E?void 0:g);continue}let m=await gt(n,e,y,p,S,D,r,i,o,a,c,s,E?void 0:g);if(m===ve)continue;return m}catch(w){throw w}})();return C.catch(()=>{}),new A(async()=>(E=!0,h&&h(),await C))},mt=async(n,e,t,r=q)=>{u("\u23ED\uFE0F","waitForCondition already finished, returning cached result:",{stepId:e});let o=n.getStepData(e)?.StepDetails?.Result;return await W(r,o,e,t,n.terminationManager,n.durableExecutionArn)},gt=async(n,e,t,r,i,o,a,c,s,d,f,l,E)=>{let h=o.serdes||q,g,C=n.getStepData(t);if(C?.Status===b.STARTED||C?.Status===b.READY){let D=C.StepDetails?.Result;if(D)try{let y={entityId:t,durableExecutionArn:n.durableExecutionArn};g=await h.deserialize(D,y)}catch(y){u("\u26A0\uFE0F","Failed to deserialize checkpoint data, using initial state:",{stepId:t,name:r,error:y}),g=o.initialState}else g=o.initialState}else g=o.initialState;let p=C?.StepDetails?.Attempt||1;n.getStepData(t)?.Status!==b.STARTED&&e.checkpoint(t,{Id:t,ParentId:l,Action:R.START,SubType:k.WAIT_FOR_CONDITION,Type:x.STEP,Name:r});try{let D={logger:a};c(t);let y;try{y=await te(t,l,()=>i(g,D),p+1,I.ExecutionMode)}finally{s(t)}let w=await he(h,y,t,r,n.terminationManager,n.durableExecutionArn),m=await W(h,w,t,r,n.terminationManager,n.durableExecutionArn),T=o.waitStrategy(m,p);return u("\u{1F50D}","waitForCondition check completed:",{stepId:t,name:r,currentAttempt:p,shouldContinue:T.shouldContinue,delayInSeconds:T.shouldContinue?O(T.delay):void 0}),T.shouldContinue?(await e.checkpoint(t,{Id:t,ParentId:l,Action:R.RETRY,SubType:k.WAIT_FOR_CONDITION,Type:x.STEP,Payload:w,Name:r,StepOptions:{NextAttemptDelaySeconds:O(T.delay)}}),await $e(n,t,r,d,e,f(),E),ve):(await e.checkpoint(t,{Id:t,ParentId:l,Action:R.SUCCEED,SubType:k.WAIT_FOR_CONDITION,Type:x.STEP,Payload:w,Name:r}),u("\u2705","waitForCondition completed successfully:",{stepId:t,name:r,result:m,totalAttempts:p}),m)}catch(D){u("\u274C","waitForCondition check function failed:",{stepId:t,name:r,error:D,currentAttempt:p}),await e.checkpoint(t,{Id:t,ParentId:l,Action:R.FAIL,SubType:k.WAIT_FOR_CONDITION,Type:x.STEP,Error:_(D),Name:r});let y=_(D);throw P.fromErrorObject(y)}},Ct=(n,e,t,r,i,o,a,c)=>new A(async()=>{for(u("\u{1F504}","Callback promise phase 2 executing:",{stepId:e,stepName:t});;){let s=n.getStepData(e);if(!s){if(u("\u26A0\uFE0F","Step data not found, waiting for callback creation:",{stepId:e}),i()){await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!1,stepId:e,context:n,hasRunningOperations:i,operationsEmitter:o});continue}return u("\u23F3","No step data found and no running operations, terminating"),J(n,L.CALLBACK_PENDING,a)}if(s.Status===b.SUCCEEDED){let d=s.CallbackDetails;if(!d?.CallbackId)throw new M(`No callback ID found for completed callback: ${e}`);let f=await W(r,d.Result,e,t,n.terminationManager,n.durableExecutionArn);return c(),f}if(s.Status===b.FAILED||s.Status===b.TIMED_OUT){let f=s.CallbackDetails?.Error;if(f){let l=new Error(f.ErrorMessage);throw l.name=f.ErrorType||"Error",l.stack=f.StackTrace?.join(`
`),new M(f.ErrorMessage||"Callback failed",l,f.ErrorData)}throw new M("Callback failed")}if(s.Status===b.STARTED){if(i()){u("\u23F3","Callback still pending, waiting for other operations"),await V({checkHasRunningOperations:!0,checkStepStatus:!0,checkTimer:!1,stepId:e,context:n,hasRunningOperations:i,operationsEmitter:o});continue}return u("\u23F3","Callback still pending, terminating"),J(n,L.CALLBACK_PENDING,a)}throw new M(`Unexpected callback status: ${s.Status}`)}}),He=()=>({serialize:async n=>n,deserialize:async n=>n}),yt=(n,e,t,r,i,o,a)=>(c,s)=>{let d,f;typeof c=="string"||c===void 0?(d=c,f=s):f=c;let l=t(),E=f?.serdes||He(),h=n.getStepData(l);ne(l,{type:x.CALLBACK,name:d,subType:k.CALLBACK},h,n);let g=(async()=>(u("\u{1F4DE}","Creating callback phase 1:",{stepId:l,name:d,config:f}),h?.Status===b.SUCCEEDED?(u("\u23ED\uFE0F","Callback already completed in phase 1:",{stepId:l}),{wasNewCallback:!1}):h?.Status===b.FAILED||h?.Status===b.TIMED_OUT?(u("\u274C","Callback already failed in phase 1:",{stepId:l}),{wasNewCallback:!1}):h?.Status===b.STARTED?(u("\u23F3","Callback already started in phase 1:",{stepId:l}),{wasNewCallback:!1}):(u("\u{1F195}","Creating new callback in phase 1:",{stepId:l,name:d}),await e.checkpoint(l,{Id:l,ParentId:a,Action:"START",SubType:k.CALLBACK,Type:x.CALLBACK,Name:d,CallbackOptions:{TimeoutSeconds:f?.timeout?O(f.timeout):void 0,HeartbeatTimeoutSeconds:f?.heartbeatTimeout?O(f.heartbeatTimeout):void 0}}),u("\u2705","Callback checkpoint completed in phase 1:",{stepId:l}),{wasNewCallback:!0})))().catch(C=>{throw u("\u274C","Callback phase 1 error:",{stepId:l,error:C.message}),C});return new A(async()=>{let{wasNewCallback:C}=await g;u("\u{1F504}","Callback phase 2 executing:",{stepId:l,name:d});let p=n.getStepData(l);if(p?.Status===b.SUCCEEDED){let m=p.CallbackDetails;if(!m?.CallbackId)throw new M(`No callback ID found for completed callback: ${l}`);let T=await W(E,m.Result,l,d,n.terminationManager,n.durableExecutionArn),z=new A(async()=>T);return o(),[z,m.CallbackId]}if(p?.Status===b.FAILED||p?.Status===b.TIMED_OUT){let m=p.CallbackDetails;if(!m?.CallbackId)throw new M(`No callback ID found for failed callback: ${l}`);let T=p.CallbackDetails?.Error,z=T?(()=>{let B=new Error(T.ErrorMessage);return B.name=T.ErrorType||"Error",B.stack=T.StackTrace?.join(`
`),new M(T.ErrorMessage||"Callback failed",B,T.ErrorData)})():new M("Callback failed");return[new A(async()=>{throw z}),m.CallbackId]}let S=p?.CallbackDetails;if(!S?.CallbackId){let m=C?`Callback ID not found in stepData after checkpoint: ${l}`:`No callback ID found for started callback: ${l}`;throw new M(m)}let D=S.CallbackId,y=C?`Callback ${d||l} created and pending external completion`:`Callback ${d||l} is pending external completion`,w=Ct(n,l,d,E,r,i(),y,o);return u("\u2705","Callback created successfully in phase 2:",{stepId:l,name:d,callbackId:D}),[w,D]})},St=(n,e,t)=>(r,i,o)=>{let a,c,s;if(typeof r=="string"||r===void 0)if(a=r,typeof i=="function")c=i,s=o;else return new A(()=>Promise.reject(new Error("waitForCallback requires a submitter function when name is provided")));else if(typeof r=="function")c=r,s=i;else return new A(()=>Promise.reject(new Error("waitForCallback requires a submitter function")));let d=(async()=>{u("\u{1F4DE}","WaitForCallback requested:",{name:a,hasSubmitter:!!c,config:s});let f=async E=>{let h=s?{timeout:s.timeout,heartbeatTimeout:s.heartbeatTimeout}:void 0,[g,C]=await E.createCallback(h);return u("\u{1F194}","Callback created:",{callbackId:C,name:a}),await E.step(async p=>{let S={logger:p.logger};u("\u{1F4E4}","Executing submitter:",{callbackId:C,name:a}),await c(C,S),u("\u2705","Submitter completed:",{callbackId:C,name:a})},s?.retryStrategy?{retryStrategy:s.retryStrategy}:void 0),u("\u23F3","Waiting for callback completion:",{callbackId:C,name:a}),await g},l=e();return{result:await t(a,f,{subType:k.WAIT_FOR_CALLBACK}),stepId:l}})();return d.catch(()=>{}),new A(async()=>{let{result:f,stepId:l}=await d;return await W(s?.serdes??He(),f,l,a,n.terminationManager,n.durableExecutionArn)})},Dt=()=>n=>JSON.stringify({type:"ParallelResult",totalCount:n.totalCount,successCount:n.successCount,failureCount:n.failureCount,startedCount:n.startedCount,completionReason:n.completionReason,status:n.status}),wt=()=>n=>JSON.stringify({type:"MapResult",totalCount:n.totalCount,successCount:n.successCount,failureCount:n.failureCount,completionReason:n.completionReason,status:n.status}),bt=(n,e)=>(t,r,i,o)=>{let a=(async()=>{let c,s,d,f;if(typeof t=="string"||t===void 0?(c=t,s=r,d=i,f=o):(s=t,d=r,f=i),u("\u{1F5FA}\uFE0F","Starting map operation:",{name:c,itemCount:s.length,maxConcurrency:f?.maxConcurrency}),!Array.isArray(s))throw new Error("Map operation requires an array of items");if(typeof d!="function")throw new Error("Map operation requires a function to process items");let l=s.map((g,C)=>({id:`map-item-${C}`,data:g,index:C,name:f?.itemNamer?f.itemNamer(g,C):void 0})),h=await e(c,l,async(g,C)=>d(C,g.data,g.index,s),{maxConcurrency:f?.maxConcurrency,topLevelSubType:k.MAP,iterationSubType:k.MAP_ITERATION,summaryGenerator:wt(),completionConfig:f?.completionConfig,serdes:f?.serdes,itemSerdes:f?.itemSerdes});return u("\u{1F5FA}\uFE0F","Map operation completed successfully:",{resultCount:h.totalCount}),h})();return a.catch(()=>{}),new A(async()=>await a)},Tt=(n,e)=>(t,r,i)=>{let o=(async()=>{let a,c,s;if(typeof t=="string"||t===void 0?(a=t,c=r,s=i):(c=t,s=r),!Array.isArray(c))throw new Error("Parallel operation requires an array of branch functions");if(u("\u{1F500}","Starting parallel operation:",{name:a,branchCount:c.length,maxConcurrency:s?.maxConcurrency}),c.some(E=>typeof E!="function"&&(typeof E!="object"||typeof E.func!="function")))throw new Error("All branches must be functions or NamedParallelBranch objects");let d=c.map((E,h)=>{let g=typeof E=="object"&&"func"in E,C=g?E.func:E,p=g?E.name:void 0;return{id:`parallel-branch-${h}`,data:C,index:h,name:p}}),l=await e(a,d,async(E,h)=>{u("\u{1F500}","Processing parallel branch:",{index:E.index});let g=await E.data(h);return u("\u2705","Parallel branch completed:",{index:E.index,result:g}),g},{maxConcurrency:s?.maxConcurrency,topLevelSubType:k.PARALLEL,iterationSubType:k.PARALLEL_BRANCH,summaryGenerator:Dt(),completionConfig:s?.completionConfig,serdes:s?.serdes,itemSerdes:s?.itemSerdes});return u("\u{1F500}","Parallel operation completed successfully:",{resultCount:l.totalCount}),l})();return o.catch(()=>{}),new A(async()=>await o)};function kt(n){return n.map(e=>e&&e.status==="rejected"&&e.reason instanceof Error?{...e,reason:{message:e.reason.message,name:e.reason.name,stack:e.reason.stack}}:e)}function xt(n){return n.map(e=>{if(e&&e.status==="rejected"&&e.reason&&typeof e.reason=="object"&&e.reason.message){let t=new Error(e.reason.message);return t.name=e.reason.name||"Error",e.reason.stack&&(t.stack=e.reason.stack),{...e,reason:t}}return e})}function At(){return{serialize:async(n,e)=>n!==void 0?JSON.stringify(kt(n)):void 0,deserialize:async(n,e)=>n!==void 0?xt(JSON.parse(n)):void 0}}var re={retryStrategy:()=>({shouldRetry:!1})},It=n=>{let e=(a,c)=>typeof a=="string"||a===void 0?{name:a,promises:c}:{name:void 0,promises:a};return{all:(a,c)=>new A(async()=>{let{name:s,promises:d}=e(a,c);return await n(s,()=>Promise.all(d),re)}),allSettled:(a,c)=>new A(async()=>{let{name:s,promises:d}=e(a,c);return await n(s,()=>Promise.allSettled(d),{...re,serdes:At()})}),any:(a,c)=>new A(async()=>{let{name:s,promises:d}=e(a,c);return await n(s,()=>Promise.any(d),re)}),race:(a,c)=>new A(async()=>{let{name:s,promises:d}=e(a,c);return await n(s,()=>Promise.race(d),re)})}},Z=class{all;completionReason;constructor(e,t){this.all=e,this.completionReason=t}succeeded(){return this.all.filter(e=>e.status===N.SUCCEEDED&&e.result!==void 0)}failed(){return this.all.filter(e=>e.status===N.FAILED&&e.error!==void 0)}started(){return this.all.filter(e=>e.status===N.STARTED)}get status(){return this.hasFailure?N.FAILED:N.SUCCEEDED}get hasFailure(){return this.all.some(e=>e.status===N.FAILED)}throwIfError(){let e=this.all.find(t=>t.status===N.FAILED)?.error;if(e)throw e}getResults(){return this.succeeded().map(e=>e.result)}getErrors(){return this.failed().map(e=>e.error)}get successCount(){return this.all.filter(e=>e.status===N.SUCCEEDED).length}get failureCount(){return this.all.filter(e=>e.status===N.FAILED).length}get startedCount(){return this.all.filter(e=>e.status===N.STARTED).length}get totalCount(){return this.all.length}};function Rt(n){if(n&&typeof n=="object"&&"all"in n&&Array.isArray(n.all)){let e=n,t=e.all.map(r=>({...r,result:r.result,error:r.error?P.fromErrorObject(r.error):void 0}));return new Z(t,e.completionReason)}return new Z([],"ALL_COMPLETED")}var De=class{operationName;skipNextOperation;constructor(e,t){this.operationName=e,this.skipNextOperation=t}isChildEntityCompleted(e,t,r){let i=`${t}-${r+1}`,o=e.getStepData(i);return!!(o&&(o.Status===b.SUCCEEDED||o.Status===b.FAILED))}async executeItems(e,t,r,i,o=I.ExecutionMode,a,c){if(o===I.ReplaySucceededContext){u("\u{1F504}",`Replay mode: Reconstructing ${this.operationName} result:`,{itemCount:e.length});let s;if(a&&c){let f=c.getStepData(a)?.ContextDetails?.Result;if(f)try{let E=await(i.serdes||q).deserialize(f,{entityId:a,durableExecutionArn:c.durableExecutionArn});E&&typeof E=="object"&&"totalCount"in E&&(s=E.totalCount,u("\u{1F4CA}","Found initial execution count:",{targetTotalCount:s}))}catch(l){u("\u26A0\uFE0F","Could not parse initial result summary:",l)}}if(s!==void 0&&a&&c)return await this.replayItems(e,t,r,i,s,c,a);u("\u26A0\uFE0F","No valid target count or context found, falling back to concurrent execution")}return await this.executeItemsConcurrently(e,t,r,i)}async replayItems(e,t,r,i,o,a,c){let s=[];u("\u{1F504}",`Replaying ${e.length} items sequentially`,{targetTotalCount:o});let d=0,f=0;for(let h of e){if(d>=o){u("\u2705","Reached target count, stopping replay",{completedCount:d,targetTotalCount:o});break}let g=`${c}-${f+1}`;if(!this.isChildEntityCompleted(a,c,f)){u("\u23ED\uFE0F","Skipping incomplete item:",{index:h.index,itemId:h.id,childEntityId:g}),this.skipNextOperation(),f++;continue}try{let C=await r.runInChildContext(h.name||h.id,p=>t(h,p),{subType:i.iterationSubType,serdes:i.itemSerdes});s.push({result:C,index:h.index,status:N.SUCCEEDED}),d++,f++,u("\u2705",`Replayed ${this.operationName} item:`,{index:h.index,itemId:h.id,completedCount:d})}catch(C){let p=C instanceof v?C:new v(C instanceof Error?C.message:String(C),C instanceof Error?C:void 0);s.push({error:p,index:h.index,status:N.FAILED}),d++,f++,u("\u274C",`Replay failed for ${this.operationName} item:`,{index:h.index,itemId:h.id,error:p.message,completedCount:d})}}u("\u{1F389}",`${this.operationName} replay completed:`,{completedCount:d,totalCount:s.length});let l=s.filter(h=>h.status===N.SUCCEEDED).length,E=()=>d===e.length?"ALL_COMPLETED":i.completionConfig?.minSuccessful!==void 0&&l>=i.completionConfig.minSuccessful?"MIN_SUCCESSFUL_REACHED":"FAILURE_TOLERANCE_EXCEEDED";return new Z(s,E())}async executeItemsConcurrently(e,t,r,i){let o=i.maxConcurrency||1/0,a=new Array(e.length),c=new Set,s=0,d=0,f=0,l=0,E=0;return u("\u{1F680}",`Starting ${this.operationName} with concurrency control:`,{itemCount:e.length,maxConcurrency:o}),new Promise(h=>{let g=()=>{let y=i.completionConfig;return!y||!Object.values(y).some(m=>m!==void 0)?E===0:!(y.toleratedFailureCount!==void 0&&E>y.toleratedFailureCount||y.toleratedFailurePercentage!==void 0&&E/e.length*100>y.toleratedFailurePercentage)},C=()=>{if(f===e.length)return!0;let y=i.completionConfig;return y?.minSuccessful!==void 0&&l>=y.minSuccessful},p=()=>f===e.length?"ALL_COMPLETED":i.completionConfig?.minSuccessful!==void 0&&l>=i.completionConfig.minSuccessful?"MIN_SUCCESSFUL_REACHED":"FAILURE_TOLERANCE_EXCEEDED",S=()=>{for(;s<o&&d<e.length&&g();){let y=d++,w=e[y];c.add(y),s++,a[y]={index:y,status:N.STARTED},u("\u25B6\uFE0F",`Starting ${this.operationName} item:`,{index:y,itemId:w.id,itemName:w.name}),r.runInChildContext(w.name||w.id,m=>t(w,m),{subType:i.iterationSubType,serdes:i.itemSerdes}).then(m=>{a[y]={result:m,index:y,status:N.SUCCEEDED},l++,u("\u2705",`${this.operationName} item completed:`,{index:y,itemId:w.id,itemName:w.name}),D()},m=>{let T=m instanceof v?m:new v(m instanceof Error?m.message:String(m),m instanceof Error?m:void 0);a[y]={error:T,index:y,status:N.FAILED},E++,u("\u274C",`${this.operationName} item failed:`,{index:y,itemId:w.id,itemName:w.name,error:T.message}),D()})}},D=()=>{if(s--,f++,C()||!g()){let y=[];for(let m=0;m<a.length;m++)a[m]!==void 0&&y.push({...a[m]});u("\u{1F389}",`${this.operationName} completed:`,{successCount:l,failureCount:E,startedCount:y.filter(m=>m.status===N.STARTED).length,totalCount:y.length});let w=new Z(y,p());h(w)}else S()};S()})}},Lt=(n,e,t)=>(r,i,o,a)=>{let c=(async()=>{let s,d,f,l;if(typeof r=="string"||r===void 0?(s=r,d=i,f=o,l=a):(d=r,f=i,l=o),u("\u{1F504}","Starting concurrent execution:",{name:s,itemCount:d.length,maxConcurrency:l?.maxConcurrency}),!Array.isArray(d))throw new Error("Concurrent execution requires an array of items");if(typeof f!="function")throw new Error("Concurrent execution requires an executor function");if(l?.maxConcurrency!==void 0&&l.maxConcurrency!==null&&l.maxConcurrency<=0)throw new Error(`Invalid maxConcurrency: ${l.maxConcurrency}. Must be a positive number or undefined for unlimited concurrency.`);let h=await e(s,async g=>{let C=new De("concurrent-execution",t),p=g.durableExecutionMode,S=g._stepPrefix;return u("\u{1F504}","Concurrent execution mode:",{mode:p,itemCount:d.length,entityId:S}),await C.executeItems(d,f,g,l||{},p,S,n)},{subType:l?.topLevelSubType,summaryGenerator:l?.summaryGenerator,serdes:l?.serdes});return h&&typeof h=="object"&&"all"in h&&Array.isArray(h.all)?Rt(h):h})();return c.catch(()=>{}),new A(async()=>await c)},we=class{captureExecutionState;checkAndUpdateReplayMode;checkForNonResolvingPromise;getDurableExecutionMode;setDurableExecutionMode;constructor(e,t,r,i,o){this.captureExecutionState=e,this.checkAndUpdateReplayMode=t,this.checkForNonResolvingPromise=r,this.getDurableExecutionMode=i,this.setDurableExecutionMode=o}withModeManagement(e){let t=this.captureExecutionState();this.checkAndUpdateReplayMode();let r=this.checkForNonResolvingPromise();if(r)return r;try{return e()}finally{t&&this.setDurableExecutionMode(I.ExecutionMode)}}withDurableModeManagement(e){let t=this.captureExecutionState();this.checkAndUpdateReplayMode();let r=this.checkForNonResolvingPromise();if(r)return new A(async()=>{throw await r,new Error("Unreachable code")});try{return e()}finally{t&&this.setDurableExecutionMode(I.ExecutionMode)}}},be=class{executionContext;lambdaContext;_stepPrefix;_stepCounter=0;durableLogger;modeAwareLoggingEnabled=!0;runningOperations=new Set;operationsEmitter=new Le;checkpoint;durableExecutionMode;_parentId;modeManagement;durableExecution;logger;constructor(e,t,r,i,o,a,c){this.executionContext=e,this.lambdaContext=t,this._stepPrefix=o,this._parentId=c,this.durableExecution=a,this.durableLogger=i,this.durableLogger.configureDurableLoggingContext?.(this.getDurableLoggingContext()),this.logger=this.createModeAwareLogger(i),this.durableExecutionMode=r,this.checkpoint=a.checkpointManager,this.modeManagement=new we(this.captureExecutionState.bind(this),this.checkAndUpdateReplayMode.bind(this),this.checkForNonResolvingPromise.bind(this),()=>this.durableExecutionMode,s=>{this.durableExecutionMode=s})}getDurableLoggingContext(){return{getDurableLogData:()=>{let e=oe(),t={executionArn:this.executionContext.durableExecutionArn,requestId:this.executionContext.requestId,tenantId:this.executionContext.tenantId,operationId:!e||e?.contextId==="root"?void 0:H(e.contextId)};return e?.attempt!==void 0&&(t.attempt=e.attempt),t}}}shouldLog(){let e=oe();return!this.modeAwareLoggingEnabled||!e?!0:e.contextId==="root"?this.durableExecutionMode===I.ExecutionMode:e.durableExecutionMode===I.ExecutionMode}createModeAwareLogger(e){let t={warn:(...r)=>{if(this.shouldLog())return e.warn(...r)},debug:(...r)=>{if(this.shouldLog())return e.debug(...r)},info:(...r)=>{if(this.shouldLog())return e.info(...r)},error:(...r)=>{if(this.shouldLog())return e.error(...r)}};return"log"in e&&(t.log=(r,...i)=>{if(this.shouldLog())return e.log?.(r,...i)}),t}createStepId(){return this._stepCounter++,this._stepPrefix?`${this._stepPrefix}-${this._stepCounter}`:`${this._stepCounter}`}getNextStepId(){let e=this._stepCounter+1;return this._stepPrefix?`${this._stepPrefix}-${e}`:`${e}`}skipNextOperation(){this._stepCounter++}checkAndUpdateReplayMode(){if(this.durableExecutionMode===I.ReplayMode){let e=this.getNextStepId();this.executionContext.getStepData(e)||(this.durableExecutionMode=I.ExecutionMode)}}captureExecutionState(){let e=this.durableExecutionMode===I.ReplayMode,t=this.getNextStepId(),r=this.executionContext.getStepData(t),i=!!(r&&r.Status!==b.SUCCEEDED&&r.Status!==b.FAILED);return e&&i}checkForNonResolvingPromise(){if(this.durableExecutionMode===I.ReplaySucceededContext){let e=this.getNextStepId(),t=this.executionContext.getStepData(e);if(t&&t.Status!==b.SUCCEEDED&&t.Status!==b.FAILED)return new Promise(()=>{})}return null}addRunningOperation(e){this.runningOperations.add(e)}removeRunningOperation(e){this.runningOperations.delete(e),this.runningOperations.size===0&&this.operationsEmitter.emit(Ee)}hasRunningOperations(){return this.runningOperations.size>0}getOperationsEmitter(){return this.operationsEmitter}withModeManagement(e){return this.modeManagement.withModeManagement(e)}withDurableModeManagement(e){return this.modeManagement.withDurableModeManagement(e)}step(e,t,r){return F(this._stepPrefix,"step",this.executionContext.terminationManager),this.withDurableModeManagement(()=>ot(this.executionContext,this.checkpoint,this.lambdaContext,this.createStepId.bind(this),this.durableLogger,this.addRunningOperation.bind(this),this.removeRunningOperation.bind(this),this.hasRunningOperations.bind(this),this.getOperationsEmitter.bind(this),this._parentId)(e,t,r))}invoke(e,t,r,i){return F(this._stepPrefix,"invoke",this.executionContext.terminationManager),this.withDurableModeManagement(()=>ut(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.hasRunningOperations.bind(this),this.getOperationsEmitter.bind(this),this._parentId,this.checkAndUpdateReplayMode.bind(this))(e,t,r,i))}runInChildContext(e,t,r){return F(this._stepPrefix,"runInChildContext",this.executionContext.terminationManager),this.withDurableModeManagement(()=>dt(this.executionContext,this.checkpoint,this.lambdaContext,this.createStepId.bind(this),()=>this.durableLogger,(o,a,c,s,d,f,l)=>qe(o,a,c,s,d,this.durableExecution,l),this._parentId)(e,t,r))}wait(e,t){return F(this._stepPrefix,"wait",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let r=ft(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.hasRunningOperations.bind(this),this.getOperationsEmitter.bind(this),this._parentId,this.checkAndUpdateReplayMode.bind(this));return typeof e=="string"?r(e,t):r(e)})}configureLogger(e){e.customLogger!==void 0&&(this.durableLogger=e.customLogger,this.durableLogger.configureDurableLoggingContext?.(this.getDurableLoggingContext()),this.logger=this.createModeAwareLogger(this.durableLogger)),e.modeAware!==void 0&&(this.modeAwareLoggingEnabled=e.modeAware)}createCallback(e,t){return F(this._stepPrefix,"createCallback",this.executionContext.terminationManager),this.withDurableModeManagement(()=>yt(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.hasRunningOperations.bind(this),this.getOperationsEmitter.bind(this),this.checkAndUpdateReplayMode.bind(this),this._parentId)(e,t))}waitForCallback(e,t,r){return F(this._stepPrefix,"waitForCallback",this.executionContext.terminationManager),this.withDurableModeManagement(()=>St(this.executionContext,this.getNextStepId.bind(this),this.runInChildContext.bind(this))(e,t,r))}waitForCondition(e,t,r){return F(this._stepPrefix,"waitForCondition",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let i=Et(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.durableLogger,this.addRunningOperation.bind(this),this.removeRunningOperation.bind(this),this.hasRunningOperations.bind(this),this.getOperationsEmitter.bind(this),this._parentId);return typeof e=="string"||e===void 0?i(e,t,r):i(e,t)})}map(e,t,r,i){return F(this._stepPrefix,"map",this.executionContext.terminationManager),this.withDurableModeManagement(()=>bt(this.executionContext,this._executeConcurrently.bind(this))(e,t,r,i))}parallel(e,t,r){return F(this._stepPrefix,"parallel",this.executionContext.terminationManager),this.withDurableModeManagement(()=>Tt(this.executionContext,this._executeConcurrently.bind(this))(e,t,r))}_executeConcurrently(e,t,r,i){return F(this._stepPrefix,"_executeConcurrently",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let a=Lt(this.executionContext,this.runInChildContext.bind(this),this.skipNextOperation.bind(this))(e,t,r,i);return a?.catch(()=>{}),a})}get promise(){return It(this.step.bind(this))}},qe=(n,e,t,r,i,o,a)=>new be(n,e,t,r,i,o,a),Te=class extends Le{isTerminated=!1;terminationDetails;resolveTermination;terminationPromise;setCheckpointTerminating;constructor(e){super(),this.setCheckpointTerminating=e,this.terminationPromise=new Promise(t=>{this.resolveTermination=t})}setCheckpointTerminatingCallback(e){this.setCheckpointTerminating=e}terminate(e={}){this.isTerminated||(this.setCheckpointTerminating?.(),this.isTerminated=!0,this.terminationDetails={reason:e.reason??L.OPERATION_TERMINATED,message:e.message??"Operation terminated",error:e.error,cleanup:e.cleanup},this.resolveTermination&&this.handleTermination(this.terminationDetails).then(this.resolveTermination))}getTerminationPromise(){return this.terminationPromise}async handleTermination(e){if(e.cleanup)try{await e.cleanup()}catch{}return{reason:e.reason,message:e.message,error:e.error}}};function Nt(n,e){return e instanceof Error?Object.assign({errorType:e?.constructor?.name??"UnknownError",errorMessage:e.message,stackTrace:typeof e.stack=="string"?e.stack.split(`
`):e.stack},e):e}function ie(n,e,...t){let r={requestId:e.requestId,timestamp:new Date().toISOString(),level:n.toUpperCase(),executionArn:e.executionArn},i=e.tenantId;if(i!=null&&i!=null&&(r.tenantId=i),e.operationId!==void 0&&(r.operationId=e.operationId),e.attempt!==void 0&&(r.attempt=e.attempt),t.length===1){r.message=t[0];try{return JSON.stringify(r,Nt)}catch{return r.message=Ne.format(r.message),JSON.stringify(r)}}r.message=Ne.format(...t);for(let o of t)if(o instanceof Error){r.errorType=o?.constructor?.name??"UnknownError",r.errorMessage=o.message,r.stackTrace=typeof o.stack=="string"?o.stack.split(`
`):[];break}return JSON.stringify(r)}var ke=class{consoleLogger;durableLoggingContext=void 0;executionContext;noOpLog=()=>{};constructor(e){this.executionContext=e,this.consoleLogger=new Xe({stdout:process.stdout,stderr:process.stderr}),this.info=this.noOpLog,this.error=this.noOpLog,this.warn=this.noOpLog,this.debug=this.noOpLog,this.configureLogLevel()}configureLogLevel(){let e={DEBUG:{name:"DEBUG",priority:2},INFO:{name:"INFO",priority:3},WARN:{name:"WARN",priority:4},ERROR:{name:"ERROR",priority:5}},t=process.env.AWS_LAMBDA_LOG_LEVEL?.toUpperCase(),r=t&&t in e?e[t]:e.DEBUG;e.DEBUG.priority>=r.priority&&(this.debug=(i,...o)=>{let a=this.ensureDurableLoggingContext(),c=i!==void 0?[i,...o]:o;this.consoleLogger.debug(ie(U.DEBUG,a.getDurableLogData(),...c))}),e.INFO.priority>=r.priority&&(this.info=(i,...o)=>{let a=this.ensureDurableLoggingContext(),c=i!==void 0?[i,...o]:o;this.consoleLogger.info(ie(U.INFO,a.getDurableLogData(),...c))}),e.WARN.priority>=r.priority&&(this.warn=(i,...o)=>{let a=this.ensureDurableLoggingContext(),c=i!==void 0?[i,...o]:o;this.consoleLogger.warn(ie(U.WARN,a.getDurableLogData(),...c))}),e.ERROR.priority>=r.priority&&(this.error=(i,...o)=>{let a=this.ensureDurableLoggingContext(),c=i!==void 0?[i,...o]:o;this.consoleLogger.error(ie(U.ERROR,a.getDurableLogData(),...c))})}ensureDurableLoggingContext(){let e=this.executionContext;if(!this.durableLoggingContext&&!e)throw new Error("DurableLoggingContext is not configured. Please call configureDurableLoggingContext before logging.");if(this.durableLoggingContext)return this.durableLoggingContext;if(!e)throw new Error("Execution context is not provided.");return{getDurableLogData:()=>({requestId:e.requestId,executionArn:e.durableExecutionArn,tenantId:e.tenantId})}}log(e,t,...r){switch(e){case U.DEBUG:this.debug(t,...r);break;case U.INFO:this.info(t,...r);break;case U.WARN:this.warn(t,...r);break;case U.ERROR:this.error(t,...r);break;default:this.info(t,...r);break}}info;error;warn;debug;configureDurableLoggingContext(e){this.durableLoggingContext=e}},xe=n=>new ke(n),Ae=class{activeCount=0;increment(){this.activeCount++}decrement(){this.activeCount=Math.max(0,this.activeCount-1)}hasActive(){return this.activeCount>0}getCount(){return this.activeCount}reset(){this.activeCount=0}},pe,Ie=class{client;constructor(e){e?this.client=e:(pe||(pe=new je({requestHandler:{connectionTimeout:5e3,socketTimeout:5e4,requestTimeout:55e3,throwOnRequestTimeout:!0}})),this.client=pe)}async getExecutionState(e,t){try{return await this.client.send(new Be({DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,Marker:e.Marker,MaxItems:e.MaxItems}))}catch(r){throw u("\u274C","GetDurableExecutionState failed",{error:r,requestId:r?.$metadata?.requestId,DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,Marker:e.Marker}),t&&t.error("Failed to get durable execution state",r,{requestId:r?.$metadata?.requestId}),r}}async checkpoint(e,t){try{return await this.client.send(new Ge({DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,ClientToken:e.ClientToken,Updates:e.Updates}))}catch(r){throw u("\u274C","CheckpointDurableExecution failed",{error:r,requestId:r?.$metadata?.requestId,DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,ClientToken:e.ClientToken}),t&&t.error("Failed to checkpoint durable execution",r,{requestId:r?.$metadata?.requestId}),r}}},Re=class{durableExecutionClient;InitialExecutionState;DurableExecutionArn;CheckpointToken;constructor(e,t){this.durableExecutionClient=t,this.InitialExecutionState=e.InitialExecutionState,this.DurableExecutionArn=e.DurableExecutionArn,this.CheckpointToken=e.CheckpointToken}},Pt=async(n,e,t)=>{u("\u{1F535}","Initializing durable function with event:",n),u("\u{1F4CD}","Function Input:",n);let r=n.CheckpointToken,i=n.DurableExecutionArn,o=n instanceof Re?n.durableExecutionClient:new Ie(t),a=xe({durableExecutionArn:i,requestId:e.awsRequestId,tenantId:e.tenantId}),c=[...n.InitialExecutionState.Operations||[]],s=n.InitialExecutionState.NextMarker;for(;s;){let l=await o.getExecutionState({CheckpointToken:r,Marker:s,DurableExecutionArn:i,MaxItems:1e3},a);c.push(...l.Operations||[]),s=l.NextMarker||""}let d=c.length>1?I.ReplayMode:I.ExecutionMode;u("\u{1F4DD}","Operations:",c);let f=c.reduce((l,E)=>(E.Id&&(l[E.Id]=E),l),{});return u("\u{1F4DD}","Loaded step data:",f),{executionContext:{durableExecutionClient:o,_stepData:f,terminationManager:new Te,activeOperationsTracker:new Ae,durableExecutionArn:i,pendingCompletions:new Set,getStepData(l){return Ve(f,l)},tenantId:e.tenantId,requestId:e.awsRequestId},durableExecutionMode:d,checkpointToken:r}},_e=6*1024*1024-50;async function Mt(n,e,t,r,i,o){let a=new Le,c=new ye(t.durableExecutionArn,t._stepData,t.durableExecutionClient,t.terminationManager,t.activeOperationsTracker,i,a,xe(t),t.pendingCompletions);t.terminationManager.setCheckpointTerminatingCallback(()=>{c.setTerminating()});let s={checkpointManager:c,stepDataEmitter:a,setTerminating:()=>c.setTerminating()},d=qe(t,e,r,xe(),void 0,s),f=n.InitialExecutionState.Operations?.[0],l=JSON.parse(f?.ExecutionDetails?.InputPayload??"{}");try{u("\u{1F3AF}",`Starting handler execution, handler event: ${l}`);let E=!1,h=!1,g=te("root",void 0,()=>o(l,d)).then(w=>(E=!0,u("\u{1F3C6}","Handler promise resolved first!"),["handler",w])),C=t.terminationManager.getTerminationPromise().then(w=>(h=!0,u("\u{1F4A5}","Termination promise resolved first!"),s.setTerminating(),["termination",w]));setTimeout(()=>{u("\u23F1\uFE0F","Promise race status check:",{handlerResolved:E,terminationResolved:h})},500);let[p,S]=await Promise.race([g,C]);u("\u{1F3C1}","Promise race completed with:",{resultType:p});try{await s.checkpointManager.waitForQueueCompletion(),u("\u2705","All pending checkpoints completed")}catch(w){u("\u26A0\uFE0F","Error waiting for checkpoint completion:",w)}if(p==="termination"&&S.reason===L.CHECKPOINT_FAILED)throw u("\u{1F6D1}","Checkpoint failed - handling termination"),S.error;if(p==="termination"&&S.reason===L.SERDES_FAILED)throw u("\u{1F6D1}","Serdes failed - terminating Lambda execution"),new me(S.message);if(p==="termination"&&S.reason===L.CONTEXT_VALIDATION_ERROR)return u("\u{1F6D1}","Context validation error - returning FAILED status"),{Status:G.FAILED,Error:_(S.error||new Error(S.message))};if(p==="termination")return u("\u{1F6D1}","Returning termination response"),{Status:G.PENDING};u("\u2705","Returning normal completion response");let D=JSON.stringify(S),y=new TextEncoder().encode(D).length;if(D&&y>_e){u("\u{1F4E6}",`Response size (${y} bytes) exceeds Lambda limit (${_e} bytes). Checkpointing result.`);let w=`execution-result-${Date.now()}`;try{return await s.checkpointManager.checkpoint(w,{Id:w,Action:"SUCCEED",Type:x.EXECUTION,Payload:D}),u("\u2705","Large result successfully checkpointed"),{Status:G.SUCCEEDED,Result:""}}catch(m){throw u("\u274C","Failed to checkpoint large result:",m),m}}return{Status:G.SUCCEEDED,Result:D}}catch(E){if(u("\u274C","Handler threw an error:",E),it(E))throw u("\u{1F6D1}","Unrecoverable invocation error - terminating Lambda execution"),E;return{Status:G.FAILED,Error:_(E)}}}function _t(n){try{let e=n;if(!e?.DurableExecutionArn||!e?.CheckpointToken)throw new Error("Missing required durable execution fields")}catch{let e=`Unexpected payload provided to start the durable execution. 
Check your resource configurations to confirm the durability is set.`;throw new Error(e)}}var We=(n,e)=>async(t,r)=>{_t(t);let{executionContext:i,durableExecutionMode:o,checkpointToken:a}=await Pt(t,r,e?.client),c=null;try{return c=await Mt(t,r,i,o,a,n),c}catch(s){throw s}},qt={maxAttempts:60,initialDelay:{seconds:5},maxDelay:{seconds:300},backoffRate:1.5,jitter:j.FULL,timeoutSeconds:void 0};var jt=We(async()=>({status:200}));export{jt as handler};
//# sourceMappingURL=index.mjs.map
